name: Release Helm charts (service tags on PR merge → gh-pages)

on:
  pull_request:
    types: [closed]
    branches:
      - master

permissions:
  contents: write
  pull-requests: read

concurrency:
  group: helm-release-gh-pages
  cancel-in-progress: false

jobs:
  release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    env:
      GH_PAGES_HOST: helm.digit.org
      CHARTS_DIR: charts

    steps:
      - name: Checkout repository at merged commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.merge_commit_sha }}

      - name: Setup Helm & yq
        run: |
          set -e
          curl -fsSL https://get.helm.sh/helm-v3.15.4-linux-amd64.tar.gz | tar xz
          sudo mv linux-amd64/helm /usr/local/bin/helm
          rm -rf linux-amd64
          curl -fsSL -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Parse PR body → module + release type
        id: parse
        shell: bash
        run: |
          set -euo pipefail
          BODY="${{ github.event.pull_request.body }}"
          MODULE=$(printf "%s\n" "$BODY" | awk -F: '/^[[:space:]]*module[[:space:]]*:/ {print $2}' | tr -d '[:space:]')
          RELEASE=$(printf "%s\n" "$BODY" | awk -F: '/^[[:space:]]*release[[:space:]]*:/ {print $2}' | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]')
          case "$RELEASE" in major|minor|patch) : ;; *) echo "::error::release must be one of major|minor|patch (found: '$RELEASE')"; exit 1 ;; esac
          if [[ -z "$MODULE" ]]; then echo "::error::module: <core|urban|health|frontend|common> must be provided in PR body"; exit 1; fi
          echo "module=$MODULE"   >> "$GITHUB_OUTPUT"
          echo "release=$RELEASE" >> "$GITHUB_OUTPUT"

      - name: Detect changed charts under module
        id: changed
        shell: bash
        run: |
          set -euo pipefail
          MODULE='${{ steps.parse.outputs.module }}'
          BASE='${{ github.event.pull_request.base.sha }}'
          HEAD='${{ github.event.pull_request.merge_commit_sha }}'
          ROOT="${CHARTS_DIR}/${MODULE}"
          if [[ "$MODULE" == "common" ]]; then
            printf "common\n" > /tmp/services.txt
          else
            test -d "$ROOT" || { echo "::error::Module directory not found: $ROOT"; exit 1; }
            git diff --name-only "$BASE" "$HEAD" -- "$ROOT" \
              | awk -F/ -v m="$MODULE" -v c="$CHARTS_DIR" '$1==c && $2==m && NF>=3 {print $3}' \
              | sort -u > /tmp/services.txt
            awk -v r="$ROOT" '{ if (system("[ -f \"" r "/" $0 "/Chart.yaml\" ]")==0) print $0 }' /tmp/services.txt > /tmp/services.filtered
            mv /tmp/services.filtered /tmp/services.txt
          fi
          COUNT=$(wc -l < /tmp/services.txt | tr -d ' ')
          if [[ "$COUNT" -eq 0 ]]; then
            echo "count=0" >> "$GITHUB_OUTPUT"
            echo "::notice::No chart changes detected; exiting."
          else
            echo "count=$COUNT" >> "$GITHUB_OUTPUT"
            echo "services=$(paste -sd, /tmp/services.txt)" >> "$GITHUB_OUTPUT"
          fi

      - name: Compute next versions, bump Chart.yaml, and create tags
        if: steps.changed.outputs.count != '0'
        id: versioning
        shell: bash
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
        run: |
          set -euo pipefail
          MODULE='${{ steps.parse.outputs.module }}'
          RELEASE='${{ steps.parse.outputs.release }}'
          MERGE_SHA='${{ github.event.pull_request.merge_commit_sha }}'
          ROOT="${CHARTS_DIR}/${MODULE}"

          bump() { local v="$1" t="$2"; local IFS=.; read -r MA MI PA <<< "${v:-0.0.0}"; case "$t" in major) echo "$((MA+1)).0.0";; minor) echo "$MA.$((MI+1)).0";; patch) echo "$MA.$MI.$((PA+1))";; esac; }
          : > /tmp/versions.txt

          git checkout -B release-tmp "$MERGE_SHA"
          git config user.name  "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"

          if [[ "$MODULE" == "common" ]]; then
            PREV=$(git tag -l | grep -E "^common/[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -1 || true)
            PREV_VER="${PREV#*/}"
            NEXT_VER=$(bump "$PREV_VER" "$RELEASE")
            yq -i '.version = "'"${NEXT_VER}"'"' "${CHARTS_DIR}/common/Chart.yaml"
            git add "${CHARTS_DIR}/common/Chart.yaml"
            git commit -m "chore(common): bump chart version to ${NEXT_VER}" || true
            git tag -a "common/${NEXT_VER}" -m "Auto(${RELEASE}) via PR merge"
            echo "common=${NEXT_VER}" >> /tmp/versions.txt
          else
            IFS=',' read -r -a SVCS <<< '${{ steps.changed.outputs.services }}'
            for SVC in "${SVCS[@]}"; do
              CHDIR="${ROOT}/${SVC}"
              test -f "${CHDIR}/Chart.yaml" || continue
              PREV=$(git tag -l | grep -E "^${MODULE}/${SVC}/[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -1 || true)
              PREV_VER="${PREV##*/}"; [[ -z "$PREV_VER" || "$PREV_VER" == "$PREV" ]] && PREV_VER="0.0.0"
              NEXT_VER=$(bump "$PREV_VER" "$RELEASE")
              yq -i '.version = "'"${NEXT_VER}"'"' "${CHDIR}/Chart.yaml"
              git add "${CHDIR}/Chart.yaml"
              echo "${SVC}=${NEXT_VER}" >> /tmp/versions.txt
            done
            git commit -m "chore(${MODULE}): bump chart versions after PR merge (${RELEASE})" || true
            while IFS='=' read -r SVC VER; do
              [[ -n "$SVC" && -n "$VER" ]] || continue
              git tag -a "${MODULE}/${SVC}/${VER}" -m "Auto(${RELEASE}) via PR merge"
            done < /tmp/versions.txt
          fi

          git push origin --tags
          echo "versions=$(paste -sd, /tmp/versions.txt)" >> "$GITHUB_OUTPUT"

      - name: Package updated charts
        if: steps.changed.outputs.count != '0'
        shell: bash
        run: |
          set -euo pipefail
          MODULE='${{ steps.parse.outputs.module }}'
          ROOT="${CHARTS_DIR}/${MODULE}"
          VERS='${{ steps.versioning.outputs.versions }}'
          mkdir -p packaged

          if [[ "$MODULE" == "common" ]]; then
            VER="$(awk -F= 'BEGIN{RS=","} $1=="common"{print $2}' <<<"$VERS")"; export VER
            yq -i '.version = env(VER)' "${CHARTS_DIR}/common/Chart.yaml"
            rm -f  "${CHARTS_DIR}/common/Chart.lock"
            rm -rf "${CHARTS_DIR}/common/charts"
            helm dependency build "${CHARTS_DIR}/common"
            mkdir -p packaged/common
            helm package "${CHARTS_DIR}/common" --destination packaged/common
          else
            IFS=',' read -r -a PAIRS <<< "$VERS"
            for pair in "${PAIRS[@]}"; do
              SVC="${pair%%=*}"
              VER="${pair##*=}"
              [[ -n "$SVC" && -n "$VER" ]] || continue
              export VER
              CHDIR="${ROOT}/${SVC}"
              test -f "${CHDIR}/Chart.yaml" || { echo "::error::Missing Chart.yaml at ${CHDIR}"; exit 1; }

              yq -i '.version = env(VER)' "${CHDIR}/Chart.yaml"
              rm -f  "${CHDIR}/Chart.lock"
              rm -rf "${CHDIR}/charts"
              helm dependency build "${CHDIR}"

              mkdir -p "packaged/${MODULE}/${SVC}"
              helm package "${CHDIR}" --destination "packaged/${MODULE}/${SVC}"
            done
          fi

      - name: Publish to gh-pages
        if: steps.changed.outputs.count != '0'
        shell: bash
        run: |
          set -euo pipefail
          MODULE='${{ steps.parse.outputs.module }}'
          HOST='${{ env.GH_PAGES_HOST }}'
          URL="https://${HOST}/${MODULE}"
          VERS='${{ steps.versioning.outputs.versions }}'
          GHP_DIR="_gh_pages"

          git worktree list | awk '{print $1}' | grep -x "${GHP_DIR}" >/dev/null 2>&1 && git worktree remove -f "${GHP_DIR}"
          rm -rf "${GHP_DIR}"

          if git ls-remote --exit-code --heads origin gh-pages >/dev/null 2>&1; then
            git fetch origin gh-pages:gh-pages
            git worktree add --force "${GHP_DIR}" gh-pages
          else
            git worktree add --force -b gh-pages "${GHP_DIR}" HEAD
            rm -rf "${GHP_DIR:?}/"* || true
          fi

          git -C "${GHP_DIR}" config user.name  "github-actions[bot]"
          git -C "${GHP_DIR}" config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          export GIT_AUTHOR_NAME="github-actions[bot]"
          export GIT_AUTHOR_EMAIL="41898282+github-actions[bot]@users.noreply.github.com"
          export GIT_COMMITTER_NAME="$GIT_AUTHOR_NAME"
          export GIT_COMMITTER_EMAIL="$GIT_AUTHOR_EMAIL"

          echo "Publishing into ${GHP_DIR}/${MODULE} (URL base: ${URL})"

          if [[ "$MODULE" == "common" ]]; then
            mkdir -p "${GHP_DIR}/common"
            cp -v packaged/common/*.tgz "${GHP_DIR}/common/" || true

            mkdir -p "${GHP_DIR}/_tmpindex"
            [[ -f "${GHP_DIR}/common/index.yaml" ]] && cp "${GHP_DIR}/common/index.yaml" "${GHP_DIR}/_tmpindex/index-old.yaml" || true
            cp -v "${GHP_DIR}/common/"*.tgz "${GHP_DIR}/_tmpindex/" || true

            if [[ -f "${GHP_DIR}/_tmpindex/index-old.yaml" ]] ; then
              helm repo index "${GHP_DIR}/_tmpindex" --url "$URL" --merge "${GHP_DIR}/_tmpindex/index-old.yaml"
            else
              helm repo index "${GHP_DIR}/_tmpindex" --url "$URL"
            fi

            mv "${GHP_DIR}/_tmpindex/index.yaml" "${GHP_DIR}/common/index.yaml"
            rm -rf "${GHP_DIR}/_tmpindex"
          else
            IFS=',' read -r -a PAIRS <<< "$VERS"
            for pair in "${PAIRS[@]}"; do
              SVC="${pair%%=*}"
              [[ -n "$SVC" ]] || continue
              mkdir -p "${GHP_DIR}/${MODULE}/${SVC}"
              cp -v "packaged/${MODULE}/${SVC}/"*.tgz "${GHP_DIR}/${MODULE}/${SVC}/" || true
            done

            mkdir -p "${GHP_DIR}/_tmpindex"
            [[ -f "${GHP_DIR}/${MODULE}/index.yaml" ]] && cp "${GHP_DIR}/${MODULE}/index.yaml" "${GHP_DIR}/_tmpindex/index-old.yaml" || true
            find "${GHP_DIR}/${MODULE}" -mindepth 2 -maxdepth 2 -name '*.tgz' -print0 \
              | while IFS= read -r -d '' f; do cp -v "$f" "${GHP_DIR}/_tmpindex/"; done

            if [[ -f "${GHP_DIR}/_tmpindex/index-old.yaml" ]]; then
              helm repo index "${GHP_DIR}/_tmpindex" --url "$URL" --merge "${GHP_DIR}/_tmpindex/index-old.yaml"
            else
              helm repo index "${GHP_DIR}/_tmpindex" --url "$URL"
            fi

            YQ_FILE="${GHP_DIR}/_tmpindex/rewrite.yq"
            printf "%s\n" \
              ".entries |= with_entries(" \
              "  .value |= map(" \
              "    .urls = [ (.urls[0] | sub(env(URL) + \"/\", env(URL) + \"/\" + .name + \"/\")) ]" \
              "  )" \
              ")" > "${YQ_FILE}"

            export URL
            yq -i -f "${YQ_FILE}" "${GHP_DIR}/_tmpindex/index.yaml"
      
            mv "${GHP_DIR}/_tmpindex/index.yaml" "${GHP_DIR}/${MODULE}/index.yaml"
            rm -rf "${GHP_DIR}/_tmpindex"
          fi

          git -C "${GHP_DIR}" add .
          git -C "${GHP_DIR}" commit -m "gh-pages: publish ${MODULE} charts" || echo "nothing to commit"
          git -C "${GHP_DIR}" push origin gh-pages
